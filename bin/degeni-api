#!/usr/bin/env python3
"""
DEGENI API Server - Real Live Backend
by BITZY.ID
"""

import os
import json
import subprocess
import glob
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs
import threading

PORT = 8321
HOME = os.path.expanduser("~")
AUTH_DIR = os.path.join(HOME, ".cli-proxy-api")
PROXY_DIR = os.path.join(HOME, "cliproxyapi")
PROXY_LOG = os.path.join(PROXY_DIR, "cliproxyapi.log")
CONFIG_FILE = os.path.join(PROXY_DIR, "config.yaml")

# Global OAuth state
oauth_process = None
oauth_provider = None

class DEGENIHandler(BaseHTTPRequestHandler):
    def log_message(self, format, *args):
        pass  # Suppress logs
    
    def send_cors_headers(self):
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
    
    def send_json(self, data, status=200):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_cors_headers()
        self.end_headers()
        self.wfile.write(json.dumps(data).encode())
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_cors_headers()
        self.end_headers()
    
    def do_GET(self):
        path = urlparse(self.path).path
        
        if path == '/api/status':
            self.get_status()
        elif path == '/api/accounts':
            self.get_accounts()
        elif path == '/api/models':
            self.get_models()
        elif path == '/api/logs':
            self.get_logs()
        elif path == '/api/config':
            self.get_config()
        else:
            self.send_json({'error': 'Not found'}, 404)
    
    def do_POST(self):
        path = urlparse(self.path).path
        
        if path == '/api/restart':
            self.restart_proxy()
        elif path == '/api/test':
            self.test_connection()
        elif path == '/api/account/toggle':
            content_length = int(self.headers.get('Content-Length', 0))
            body = json.loads(self.rfile.read(content_length)) if content_length else {}
            self.toggle_account(body.get('filename'))
        elif path == '/api/model/switch':
            content_length = int(self.headers.get('Content-Length', 0))
            body = json.loads(self.rfile.read(content_length)) if content_length else {}
            self.switch_model(body.get('model'))
        elif path == '/api/oauth/start':
            content_length = int(self.headers.get('Content-Length', 0))
            body = json.loads(self.rfile.read(content_length)) if content_length else {}
            self.start_oauth(body.get('provider', 'antigravity'))
        elif path == '/api/oauth/complete':
            content_length = int(self.headers.get('Content-Length', 0))
            body = json.loads(self.rfile.read(content_length)) if content_length else {}
            self.complete_oauth(body.get('callback_url', ''))
        elif path == '/api/account/delete':
            content_length = int(self.headers.get('Content-Length', 0))
            body = json.loads(self.rfile.read(content_length)) if content_length else {}
            self.delete_account(body.get('filename'))
        else:
            self.send_json({'error': 'Not found'}, 404)
    
    def get_status(self):
        """Get proxy server status"""
        try:
            result = subprocess.run(['pgrep', '-f', 'cli-proxy-api'], capture_output=True, text=True)
            is_running = result.returncode == 0
            pid = result.stdout.strip().split('\n')[0] if is_running else None
            
            # Count accounts
            antigravity = len(glob.glob(os.path.join(AUTH_DIR, 'antigravity-*.json')))
            gemini = len([f for f in glob.glob(os.path.join(AUTH_DIR, '*.json')) if 'antigravity' not in f])
            disabled = len(glob.glob(os.path.join(AUTH_DIR, '*.disabled')))
            
            # Check for limit/quota issues in recent logs
            limit_hit = False
            limit_model = ''
            limit_msg = ''
            
            if os.path.exists(PROXY_LOG):
                try:
                    result_log = subprocess.run(['tail', '-100', PROXY_LOG], capture_output=True, text=True)
                    log_content = result_log.stdout.lower()
                    
                    # Check for various limit indicators
                    limit_keywords = [
                        'payment_required', 'quota', 'rate limit', 'limit exceeded',
                        'too many requests', '429', 'resource_exhausted', 
                        'billing', 'exceeded', 'daily limit'
                    ]
                    
                    for keyword in limit_keywords:
                        if keyword in log_content:
                            limit_hit = True
                            # Try to extract model name from log
                            for line in result_log.stdout.split('\n')[-20:]:
                                if keyword in line.lower():
                                    limit_msg = line[:100]
                                    # Extract model if present
                                    if 'claude' in line.lower():
                                        limit_model = 'claude'
                                    elif 'gemini' in line.lower():
                                        limit_model = 'gemini'
                                    break
                            break
                except:
                    pass
            
            self.send_json({
                'online': is_running,
                'pid': pid,
                'accounts': {
                    'antigravity': antigravity,
                    'gemini': gemini,
                    'disabled': disabled,
                    'total': antigravity + gemini
                },
                'limit': {
                    'hit': limit_hit,
                    'model': limit_model,
                    'message': limit_msg
                }
            })
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def get_accounts(self):
        """Get all registered accounts"""
        accounts = []
        
        # Antigravity accounts
        for f in glob.glob(os.path.join(AUTH_DIR, 'antigravity-*.json')):
            filename = os.path.basename(f)
            email = filename.replace('antigravity-', '').replace('.json', '').replace('_', '@').replace('@gmail@com', '@gmail.com')
            
            # Try to read project from file
            project = ''
            try:
                with open(f, 'r') as file:
                    data = json.load(file)
                    project = data.get('project_id', '')
            except:
                pass
            
            accounts.append({
                'type': 'antigravity',
                'email': email,
                'project': project,
                'filename': filename,
                'active': True,
                'path': f
            })
        
        # Disabled accounts
        for f in glob.glob(os.path.join(AUTH_DIR, '*.disabled')):
            filename = os.path.basename(f)
            email = filename.replace('antigravity-', '').replace('.json.disabled', '').replace('_', '@').replace('@gmail@com', '@gmail.com')
            accounts.append({
                'type': 'antigravity',
                'email': email,
                'project': '',
                'filename': filename,
                'active': False,
                'path': f
            })
        
        # Gemini CLI accounts
        for f in glob.glob(os.path.join(AUTH_DIR, '*.json')):
            if 'antigravity' not in f:
                filename = os.path.basename(f)
                accounts.append({
                    'type': 'gemini-cli',
                    'email': filename.replace('.json', ''),
                    'project': '',
                    'filename': filename,
                    'active': True,
                    'path': f
                })
        
        self.send_json({'accounts': accounts})
    
    def get_models(self):
        """Get available models from proxy API"""
        try:
            # Read API key from config
            api_key = ''
            with open(CONFIG_FILE, 'r') as f:
                for line in f:
                    if 'sk-' in line and 'api-keys' not in line:
                        api_key = line.strip().strip('- "\'')
                        break
            
            if not api_key:
                api_key = 'sk-OeMG7duPNQb7wSPPqMLng3UnqhgCXxhfkhM4VNAxRH8dR'
            
            result = subprocess.run([
                'curl', '-s', 'http://localhost:8317/v1/models',
                '-H', f'Authorization: Bearer {api_key}'
            ], capture_output=True, text=True, timeout=10)
            
            data = json.loads(result.stdout)
            self.send_json(data)
        except Exception as e:
            self.send_json({'error': str(e), 'data': []}, 500)
    
    def get_logs(self):
        """Get recent logs"""
        logs = []
        try:
            if os.path.exists(PROXY_LOG):
                result = subprocess.run(['tail', '-50', PROXY_LOG], capture_output=True, text=True)
                for line in result.stdout.strip().split('\n'):
                    if line:
                        log_type = 'info'
                        if 'error' in line.lower() or 'failed' in line.lower():
                            log_type = 'error'
                        elif 'warn' in line.lower() or 'rate limit' in line.lower():
                            log_type = 'warn'
                        elif 'success' in line.lower() or '200' in line:
                            log_type = 'ok'
                        logs.append({'msg': line, 'type': log_type})
        except Exception as e:
            logs.append({'msg': str(e), 'type': 'error'})
        
        self.send_json({'logs': logs[-30:]})  # Last 30 entries
    
    def get_config(self):
        """Get current model config"""
        try:
            # Read from ai wrapper script
            ai_script = os.path.join(HOME, 'DEGENI', 'bin', 'ai')
            current_model = 'gemini-claude-sonnet-4-5-thinking'
            
            if os.path.exists(ai_script):
                with open(ai_script, 'r') as f:
                    content = f.read()
                    for line in content.split('\n'):
                        if 'ANTHROPIC_DEFAULT_SONNET_MODEL=' in line:
                            current_model = line.split('=')[1].strip()
                            break
            
            self.send_json({'current_model': current_model})
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def restart_proxy(self):
        """Restart proxy server"""
        try:
            subprocess.run(['pkill', '-9', 'cli-proxy-api'], capture_output=True)
            subprocess.Popen(
                ['nohup', './cli-proxy-api'],
                cwd=PROXY_DIR,
                stdout=open(PROXY_LOG, 'w'),
                stderr=subprocess.STDOUT,
                start_new_session=True
            )
            self.send_json({'success': True, 'message': 'Proxy restarted'})
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def test_connection(self):
        """Test API connection"""
        try:
            api_key = 'sk-OeMG7duPNQb7wSPPqMLng3UnqhgCXxhfkhM4VNAxRH8dR'
            result = subprocess.run([
                'curl', '-s', '-X', 'POST', 'http://localhost:8317/v1/messages',
                '-H', f'Authorization: Bearer {api_key}',
                '-H', 'Content-Type: application/json',
                '-H', 'anthropic-version: 2023-06-01',
                '-d', '{"model":"gemini-claude-sonnet-4-5-thinking","max_tokens":5,"messages":[{"role":"user","content":"hi"}]}'
            ], capture_output=True, text=True, timeout=30)
            
            if 'content' in result.stdout:
                self.send_json({'success': True, 'message': 'Connection OK'})
            else:
                self.send_json({'success': False, 'message': result.stdout[:200]})
        except Exception as e:
            self.send_json({'success': False, 'error': str(e)}, 500)
    
    def toggle_account(self, filename):
        """Enable/disable account"""
        if not filename:
            self.send_json({'error': 'Filename required'}, 400)
            return
        
        try:
            if filename.endswith('.disabled'):
                # Enable
                old_path = os.path.join(AUTH_DIR, filename)
                new_path = old_path.replace('.disabled', '')
                os.rename(old_path, new_path)
                self.send_json({'success': True, 'action': 'enabled', 'filename': os.path.basename(new_path)})
            else:
                # Disable
                old_path = os.path.join(AUTH_DIR, filename)
                new_path = old_path + '.disabled'
                os.rename(old_path, new_path)
                self.send_json({'success': True, 'action': 'disabled', 'filename': os.path.basename(new_path)})
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def switch_model(self, model):
        """Switch AI model"""
        if not model:
            self.send_json({'error': 'Model required'}, 400)
            return
        
        try:
            ai_script = os.path.join(HOME, 'DEGENI', 'bin', 'ai')
            if os.path.exists(ai_script):
                with open(ai_script, 'r') as f:
                    content = f.read()
                
                # Replace model
                import re
                content = re.sub(
                    r'ANTHROPIC_DEFAULT_SONNET_MODEL=.*',
                    f'ANTHROPIC_DEFAULT_SONNET_MODEL={model}',
                    content
                )
                content = re.sub(
                    r'ANTHROPIC_DEFAULT_OPUS_MODEL=.*',
                    f'ANTHROPIC_DEFAULT_OPUS_MODEL={model}',
                    content
                )
                
                with open(ai_script, 'w') as f:
                    f.write(content)
                
                self.send_json({'success': True, 'model': model})
            else:
                self.send_json({'error': 'AI script not found'}, 404)
        except Exception as e:
            self.send_json({'error': str(e)}, 500)


    def start_oauth(self, provider):
        """Start OAuth flow - returns URL, saves state to file"""
        try:
            global oauth_process, oauth_provider
            
            # Kill any existing oauth process
            if oauth_process:
                try:
                    oauth_process.kill()
                except:
                    pass
                oauth_process = None
            
            if provider == 'antigravity':
                cmd = ['./cli-proxy-api', '-antigravity-login', '-no-browser']
            else:
                cmd = ['./cli-proxy-api', '-login', '-no-browser']
            
            oauth_provider = provider
            
            # Run command and capture output to get OAuth URL
            process = subprocess.Popen(
                cmd,
                cwd=PROXY_DIR,
                stdin=subprocess.PIPE,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1  # Line buffered
            )
            
            # Read output to find URL with timeout
            oauth_url = None
            output_lines = []
            
            import time
            import re
            
            # Set a deadline
            deadline = time.time() + 15
            
            while time.time() < deadline:
                if process.poll() is not None:
                    # Process exited
                    break
                    
                try:
                    line = process.stdout.readline()
                    if line:
                        output_lines.append(line.strip())
                        # Look for Google OAuth URL specifically
                        # Must contain accounts.google.com or aistudio.google.com
                        urls = re.findall(r'https://(?:accounts\.google\.com|aistudio\.google\.com)[^\s\'"<>\)]*', line)
                        if urls:
                            oauth_url = urls[0].rstrip(')')
                            break
                except:
                    time.sleep(0.1)
            
            if oauth_url:
                # Store process globally
                oauth_process = process
                
                # Also save to state file for reliability
                state_file = os.path.join(HOME, '.degeni_oauth_state')
                with open(state_file, 'w') as f:
                    json.dump({
                        'pid': process.pid,
                        'provider': provider,
                        'url': oauth_url,
                        'started': time.time()
                    }, f)
                
                self.send_json({
                    'success': True, 
                    'url': oauth_url, 
                    'provider': provider,
                    'pid': process.pid
                })
            else:
                process.kill()
                self.send_json({
                    'success': False, 
                    'error': 'Could not get OAuth URL',
                    'output': '\n'.join(output_lines[-10:]),
                    'hint': 'Try running in terminal: degeni add'
                }, 500)
                
        except Exception as e:
            self.send_json({'success': False, 'error': str(e)}, 500)
    
    def complete_oauth(self, callback_url):
        """Complete OAuth with callback URL"""
        try:
            global oauth_process
            import time
            
            if not callback_url:
                self.send_json({'error': 'Callback URL required'}, 400)
                return
            
            # Count existing accounts before
            existing_accounts = len(glob.glob(os.path.join(AUTH_DIR, '*.json')))
            
            # Try global process first
            process_alive = oauth_process and oauth_process.poll() is None
            
            if process_alive:
                try:
                    # Send callback URL to stdin
                    oauth_process.stdin.write(callback_url + '\n')
                    oauth_process.stdin.flush()
                    
                    # Wait for process to complete
                    try:
                        oauth_process.wait(timeout=30)
                    except subprocess.TimeoutExpired:
                        oauth_process.kill()
                    
                    oauth_process = None
                    
                    # Check for new account
                    time.sleep(1)
                    new_accounts = len(glob.glob(os.path.join(AUTH_DIR, '*.json')))
                    
                    if new_accounts > existing_accounts:
                        self.send_json({'success': True, 'message': 'Account added successfully!'})
                    else:
                        self.send_json({
                            'success': True, 
                            'message': 'OAuth completed. Refresh to check accounts.',
                            'note': 'If not showing, restart proxy: degeni restart'
                        })
                    return
                    
                except Exception as e:
                    oauth_process = None
                    # Fall through to alternative method
            
            # Alternative: Run fresh process with stdin
            # This handles expired session by running a new login
            self.send_json({
                'success': False, 
                'error': 'OAuth session expired',
                'hint': 'Click "Open Google Login" to start again, or run: degeni add'
            }, 400)
            
        except Exception as e:
            self.send_json({'success': False, 'error': str(e)}, 500)
    
    def delete_account(self, filename):
        """Delete an account"""
        if not filename:
            self.send_json({'error': 'Filename required'}, 400)
            return
        
        try:
            filepath = os.path.join(AUTH_DIR, filename)
            if os.path.exists(filepath):
                os.remove(filepath)
                self.send_json({'success': True, 'message': f'Deleted {filename}'})
            elif os.path.exists(filepath + '.disabled'):
                os.remove(filepath + '.disabled')
                self.send_json({'success': True, 'message': f'Deleted {filename}'})
            else:
                self.send_json({'error': 'Account not found'}, 404)
        except Exception as e:
            self.send_json({'error': str(e)}, 500)


# Global variable for OAuth process
oauth_process = None


def run_server():
    server = HTTPServer(('127.0.0.1', PORT), DEGENIHandler)
    print(f"DEGENI API Server running on http://localhost:{PORT}")
    server.serve_forever()


if __name__ == '__main__':
    run_server()
