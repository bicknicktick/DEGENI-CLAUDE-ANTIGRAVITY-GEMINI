#!/bin/bash
#‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  DEGENI - Claude + Gemini AI Manager | by BITZY.ID
#‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

VERSION="1.0.0"
DEGENI_HOME="$HOME/DEGENI"
AUTH_DIR="$HOME/.cli-proxy-api"
PROXY_DIR="$HOME/cliproxyapi"
CONFIG_FILE="$DEGENI_HOME/config/model.conf"

R='\033[0;31m' G='\033[0;32m' Y='\033[1;33m' B='\033[0;34m'
C='\033[0;36m' M='\033[0;35m' W='\033[1;37m' D='\033[0;90m' NC='\033[0m'

# Get current model from config
get_model() {
    if [ -f "$CONFIG_FILE" ]; then
        grep "^MODEL=" "$CONFIG_FILE" | cut -d'=' -f2
    else
        echo "gemini-claude-sonnet-4-5-thinking"
    fi
}

# Auto-start services on launch
ensure_services() {
    # Start proxy if not running
    if ! pgrep -f "cli-proxy-api" > /dev/null 2>&1; then
        if [ -f "$PROXY_DIR/cli-proxy-api" ]; then
            cd "$PROXY_DIR" && nohup ./cli-proxy-api > cliproxyapi.log 2>&1 &
            sleep 2
        fi
    fi
    
    # Start API server if not running
    if ! pgrep -f "degeni-api" > /dev/null 2>&1; then
        if [ -f "$DEGENI_HOME/bin/degeni-api" ]; then
            mkdir -p "$DEGENI_HOME/logs"
            nohup python3 "$DEGENI_HOME/bin/degeni-api" > "$DEGENI_HOME/logs/api.log" 2>&1 &
            sleep 1
        fi
    fi
}

# Run on startup
ensure_services

print_logo() {
    echo -e "${C}"
    cat << 'EOF'
  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù
EOF
    echo -e "${NC}"
    echo -e "${D}  Claude + Gemini AI Terminal | by BITZY.ID | v$VERSION${NC}"
    echo ""
}

draw_line() { echo -e "${C}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"; }

success() { echo -e " ${G}‚úì${NC} $1"; }
error() { echo -e " ${R}‚úó${NC} $1"; }
warning() { echo -e " ${Y}!${NC} $1"; }
info() { echo -e " ${B}‚Üí${NC} $1"; }

quick_status() {
    echo -e "${C}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e " ${W}DEGENI QUICK STATUS${NC}"
    echo -e "${C}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    
    # Live API test
    echo -ne "  Testing API... "
    local test_result=$(timeout 8 curl -s -X POST http://localhost:8317/v1/messages \
        -H "x-api-key: $(grep -A1 'api-keys:' $PROXY_DIR/config.yaml | tail -1 | sed 's/.*\"\(sk-[^\"]*\)\".*/\1/')" \
        -H "Content-Type: application/json" \
        -H "anthropic-version: 2023-06-01" \
        -d '{"model":"gemini-claude-sonnet-4-5-thinking","max_tokens":5,"messages":[{"role":"user","content":"test"}]}' 2>&1)
    
    if echo "$test_result" | grep -q "content\|text"; then
        echo -e "${G}‚úì WORKING${NC}"
        echo -e "  Status: ${G}‚óè NO LIMITS - Ready to use!${NC}"
    elif echo "$test_result" | grep -q "429\|rate.limit\|quota"; then
        echo -e "${R}‚úó RATE LIMITED${NC}"
        echo -e "  Status: ${R}‚óè LIMIT CONFIRMED${NC}"
        echo -e "  Fix: ${C}degeni model${NC} (switch model)"
    elif echo "$test_result" | grep -q "payment_required\|unauthorized"; then
        echo -e "${R}‚úó AUTH ERROR${NC}"
        echo -e "  Status: ${R}‚óè NEED RE-AUTH${NC}"
        echo -e "  Fix: ${C}degeni add${NC} (login ulang)"
    else
        echo -e "${Y}? UNKNOWN${NC}"
        echo -e "  Status: ${Y}‚óè PROXY ISSUE${NC}"
        echo -e "  Fix: ${C}degeni restart${NC}"
    fi
    
    echo -e "${C}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

list_accounts() {
    draw_line
    echo -e " ${W}REGISTERED ACCOUNTS${NC}"
    draw_line
    echo ""
    
    local i=1
    for f in $AUTH_DIR/antigravity-*.json; do
        if [ -f "$f" ]; then
            local email=$(basename "$f" | sed 's/antigravity-//' | sed 's/.json//' | sed 's/_/./g' | sed 's/.gmail.com/@gmail.com/')
            local status="${G}‚óè Active${NC}"
            grep -q "Suspended.*$(basename $f)" "$PROXY_DIR/cliproxyapi.log" 2>/dev/null && status="${R}‚óè Suspended${NC}"
            [[ "$f" == *.disabled ]] && status="${Y}‚óè Disabled${NC}"
            
            echo -e "  ${W}[$i]${NC} ${C}$email${NC}"
            echo -e "      $status"
            echo ""
            ((i++))
        fi
    done
    
    [ "$i" -eq 1 ] && echo -e "  ${D}No Antigravity accounts found${NC}\n  ${D}Run: degeni add${NC}\n"
}

add_account() {
    draw_line
    echo -e " ${W}ADD NEW ACCOUNT${NC}"
    draw_line
    echo ""
    echo -e "  ${W}Select provider:${NC}"
    echo ""
    echo -e "  ${C}[1]${NC} Antigravity ${G}(Claude wrappers + 10+ models)${NC}"
    echo -e "  ${C}[2]${NC} Gemini CLI ${D}(Standard Gemini models)${NC}"
    echo ""
    read -p "  Choice [1-2]: " choice
    
    case $choice in
        1)
            info "Starting Antigravity OAuth..."
            echo ""
            echo -e "  ${Y}INSTRUCTIONS:${NC}"
            echo -e "  1. A URL will appear below"
            echo -e "  2. Open it in your browser"
            echo -e "  3. Login with Google AI Pro account"
            echo -e "  4. After authorize, copy the callback URL"
            echo -e "  5. Paste it here when prompted"
            echo ""
            read -p "  Press Enter to continue..."
            cd "$PROXY_DIR"
            ./cli-proxy-api --antigravity-login
            ;;
        2)
            info "Starting Gemini CLI OAuth..."
            cd "$PROXY_DIR"
            ./cli-proxy-api --login
            ;;
        *) error "Invalid choice" ;;
    esac
}

disable_account() {
    list_accounts
    read -p "  Select account number to disable: " num
    local i=1
    for f in $AUTH_DIR/antigravity-*.json; do
        if [ "$i" -eq "$num" ] && [ -f "$f" ]; then
            mv "$f" "$f.disabled"
            success "Disabled: $(basename $f)"
            warning "Run 'degeni restart' to apply"
            return
        fi
        ((i++))
    done
    error "Invalid selection"
}

enable_account() {
    draw_line
    echo -e " ${W}DISABLED ACCOUNTS${NC}"
    draw_line
    echo ""
    local i=1
    for f in $AUTH_DIR/*.disabled; do
        [ -f "$f" ] && echo -e "  ${W}[$i]${NC} $(basename $f)" && ((i++))
    done
    [ "$i" -eq 1 ] && info "No disabled accounts" && return
    
    read -p "  Select to enable: " num
    i=1
    for f in $AUTH_DIR/*.disabled; do
        if [ "$i" -eq "$num" ] && [ -f "$f" ]; then
            mv "$f" "${f%.disabled}"
            success "Enabled!"
            warning "Run 'degeni restart' to apply"
            return
        fi
        ((i++))
    done
}

restart_proxy() {
    info "Stopping proxy..."
    pkill -9 cli-proxy-api 2>/dev/null
    sleep 2
    info "Starting proxy..."
    cd "$PROXY_DIR"
    nohup ./cli-proxy-api > cliproxyapi.log 2>&1 &
    echo $! > "$HOME/cliproxyapi.pid"
    sleep 3
    pgrep -f "cli-proxy-api" > /dev/null && success "Proxy started! All accounts unsuspended." || error "Failed to start"
}

test_accounts() {
    draw_line
    echo -e " ${W}TESTING ACCOUNTS${NC}"
    draw_line
    echo ""
    for f in $AUTH_DIR/antigravity-*.json; do
        if [ -f "$f" ]; then
            local email=$(basename "$f" | sed 's/antigravity-//' | sed 's/.json//' | sed 's/_/./g' | sed 's/.gmail.com/@gmail.com/')
            echo -ne "  Testing ${C}$email${NC}... "
            local result=$(timeout 20 curl -s -X POST http://localhost:8317/v1/messages \
                -H "x-api-key: $(grep -A1 'api-keys:' $PROXY_DIR/config.yaml | tail -1 | sed 's/.*\"\(sk-[^\"]*\)\".*/\1/')" \
                -H "Content-Type: application/json" \
                -H "anthropic-version: 2023-06-01" \
                -d '{"model":"gemini-claude-sonnet-4-5-thinking","max_tokens":5,"messages":[{"role":"user","content":"hi"}]}' 2>&1)
            echo "$result" | grep -q "content" && echo -e "${G}‚úì OK${NC}" || echo -e "${R}‚úó FAILED${NC}"
        fi
    done
    echo ""
}

switch_model() {
    draw_line
    echo -e " ${W}SWITCH AI MODEL${NC}"
    draw_line
    echo ""
    echo -e "  ${C}[1]${NC} gemini-claude-sonnet-4-5-thinking ${G}‚òÖ Recommended${NC}"
    echo -e "  ${C}[2]${NC} gemini-claude-opus-4-5-thinking"
    echo -e "  ${C}[3]${NC} gemini-claude-sonnet-4-5"
    echo -e "  ${C}[4]${NC} gemini-3-pro-preview ${Y}(Free, stable)${NC}"
    echo -e "  ${C}[5]${NC} gemini-2.5-pro"
    echo -e "  ${C}[6]${NC} gemini-2.5-flash ${D}(Fast)${NC}"
    echo ""
    read -p "  Select [1-6]: " choice
    
    local models=("gemini-claude-sonnet-4-5-thinking" "gemini-claude-opus-4-5-thinking" "gemini-claude-sonnet-4-5" "gemini-3-pro-preview" "gemini-2.5-pro" "gemini-2.5-flash")
    if [ "$choice" -ge 1 ] 2>/dev/null && [ "$choice" -le 6 ] 2>/dev/null; then
        local model=${models[$((choice-1))]}
        mkdir -p "$DEGENI_HOME/config"
        echo "MODEL=$model" > "$CONFIG_FILE"
        [ -f ~/DEGENI/bin/ai ] && sed -i "s/ANTHROPIC_DEFAULT_SONNET_MODEL=.*/ANTHROPIC_DEFAULT_SONNET_MODEL=$model/g" ~/DEGENI/bin/ai
        [ -f ~/DEGENI/bin/ai ] && sed -i "s/ANTHROPIC_DEFAULT_OPUS_MODEL=.*/ANTHROPIC_DEFAULT_OPUS_MODEL=$model/g" ~/DEGENI/bin/ai
        success "Switched to: $model"
    else
        error "Invalid"
    fi
}

view_errors() {
    diagnose_problems
}

diagnose_problems() {
    draw_line
    echo -e " ${W}üîç DIAGNOSTICS & PROBLEM SOLVER${NC}"
    draw_line
    echo ""
    
    local has_problems=0
    local problem_count=0
    
    # Check 1: Proxy server running?
    echo -e "  ${W}[1] Proxy Server${NC}"
    if pgrep -f "cli-proxy-api" > /dev/null 2>&1; then
        echo -e "      ${G}‚úì Online${NC}"
    else
        echo -e "      ${R}‚úó OFFLINE${NC}"
        echo -e "      ${Y}Problem:${NC} Proxy server tidak jalan"
        echo -e "      ${C}Solution:${NC} degeni restart"
        has_problems=1
        ((problem_count++))
    fi
    echo ""
    
    # Check 2: Accounts exist?
    echo -e "  ${W}[2] Accounts${NC}"
    local ag_count=$(ls $AUTH_DIR/antigravity-*.json 2>/dev/null | grep -v disabled | wc -l)
    if [ "$ag_count" -gt 0 ]; then
        echo -e "      ${G}‚úì $ag_count Antigravity account(s)${NC}"
    else
        echo -e "      ${R}‚úó No accounts${NC}"
        echo -e "      ${Y}Problem:${NC} Belum ada akun Google AI"
        echo -e "      ${C}Solution:${NC} degeni add"
        has_problems=1
        ((problem_count++))
    fi
    echo ""
    
    # Check 3: Rate Limit / Quota errors (RECENT ONLY)
    echo -e "  ${W}[3] Rate Limits${NC}"
    if [ -f "$PROXY_DIR/cliproxyapi.log" ]; then
        # Only check last 100 lines for recent errors
        local rate_errors=$(tail -100 "$PROXY_DIR/cliproxyapi.log" 2>/dev/null | grep -E "\[error\].*429|\[error\].*rate.limit|\[error\].*quota|HTTP.*429|rate_limit_exceeded" | wc -l || echo "0")
        # Only flag as problem if there are recent errors (last 5 minutes)
        local recent_errors=$(tail -50 "$PROXY_DIR/cliproxyapi.log" 2>/dev/null | grep -E "$(date '+%Y-%m-%d %H:%M'|cut -c1-13)" | grep -E "429|rate.limit|quota" | wc -l || echo "0")
        if [ "$recent_errors" -gt 0 ]; then
            echo -e "      ${Y}! $recent_errors recent rate limit(s)${NC}"
            echo -e "      ${Y}Problem:${NC} Model mencapai quota limit (aktif)"
            echo -e "      ${C}Solution:${NC}"
            echo -e "        1. degeni restart ${D}(clear suspended)${NC}"
            echo -e "        2. degeni model ${D}(switch model)${NC}"
            echo -e "        3. degeni add ${D}(tambah akun)${NC}"
            has_problems=1
            ((problem_count++))
        elif [ "$rate_errors" -gt 0 ]; then
            echo -e "      ${D}~ $rate_errors old rate limit(s) (resolved)${NC}"
        else
            echo -e "      ${G}‚úì No rate limits${NC}"
        fi
    fi
    echo ""
    
    # Check 4: Payment Required errors (RECENT ONLY)
    echo -e "  ${W}[4] Payment/Auth Errors${NC}"
    if [ -f "$PROXY_DIR/cliproxyapi.log" ]; then
        # Only check last 50 lines for recent payment errors
        local pay_errors=$(tail -50 "$PROXY_DIR/cliproxyapi.log" 2>/dev/null | grep -c "payment_required\|auth_unavailable\|unauthorized" | head -1 || echo "0")
        pay_errors=${pay_errors:-0}
        if [ "$pay_errors" -gt 0 ] 2>/dev/null; then
            echo -e "      ${R}‚úó $pay_errors recent payment/auth error(s)${NC}"
            echo -e "      ${Y}Problem:${NC} Token expired atau akun perlu reauth"
            echo -e "      ${C}Solution:${NC}"
            echo -e "        1. degeni restart ${D}(refresh token)${NC}"
            echo -e "        2. degeni add ${D}(re-login akun)${NC}"
            has_problems=1
            ((problem_count++))
        else
            echo -e "      ${G}‚úì No recent auth errors${NC}"
        fi
    fi
    echo ""
    
    # Check 5: Suspended accounts (RECENT ONLY)
    echo -e "  ${W}[5] Suspended Accounts${NC}"
    if [ -f "$PROXY_DIR/cliproxyapi.log" ]; then
        # Only check last 20 lines for active suspensions
        local suspended=$(tail -20 "$PROXY_DIR/cliproxyapi.log" 2>/dev/null | grep -c "Suspended" | head -1 || echo "0")
        suspended=${suspended:-0}
        if [ "$suspended" -gt 0 ] 2>/dev/null; then
            echo -e "      ${Y}! $suspended recent suspension(s)${NC}"
            echo -e "      ${Y}Problem:${NC} Beberapa akun di-suspend sementara"
            echo -e "      ${C}Solution:${NC} degeni restart ${D}(auto unsuspend)${NC}"
            has_problems=1
            ((problem_count++))
        else
            echo -e "      ${G}‚úì No active suspensions${NC}"
        fi
    fi
    echo ""
    
    # Check 6: Live API Connection Test
    echo -e "  ${W}[6] Live API Test${NC}"
    local test_result=$(timeout 10 curl -s -X POST http://localhost:8317/v1/messages \
        -H "x-api-key: $(grep -A1 'api-keys:' $PROXY_DIR/config.yaml | tail -1 | sed 's/.*\"\(sk-[^\"]*\)\".*/\1/')" \
        -H "Content-Type: application/json" \
        -H "anthropic-version: 2023-06-01" \
        -d '{"model":"gemini-claude-sonnet-4-5-thinking","max_tokens":5,"messages":[{"role":"user","content":"hi"}]}' 2>&1)
    
    if echo "$test_result" | grep -q "content\|text"; then
        echo -e "      ${G}‚úì API working - NO LIMITS${NC}"
    elif echo "$test_result" | grep -q "429\|rate.limit\|quota"; then
        echo -e "      ${R}‚úó RATE LIMITED (confirmed)${NC}"
        echo -e "      ${Y}Problem:${NC} Model benar-benar limit saat ini"
        echo -e "      ${C}Solution:${NC} degeni model ${D}(switch ke model lain)${NC}"
        has_problems=1
        ((problem_count++))
    elif echo "$test_result" | grep -q "payment_required\|unauthorized"; then
        echo -e "      ${R}‚úó AUTH ERROR (confirmed)${NC}"
        echo -e "      ${Y}Problem:${NC} Akun perlu re-auth"
        echo -e "      ${C}Solution:${NC} degeni add ${D}(login ulang)${NC}"
        has_problems=1
        ((problem_count++))
    else
        echo -e "      ${Y}? API not responding properly${NC}"
        echo -e "      ${D}Response: $(echo "$test_result" | head -1 | cut -c1-50)...${NC}"
        has_problems=1
        ((problem_count++))
    fi
    echo ""
    
    draw_line
    if [ "$has_problems" -eq 0 ]; then
        echo -e " ${G}‚úì ALL SYSTEMS OK - No problems detected!${NC}"
    else
        echo -e " ${Y}‚ö† Found $problem_count problem(s)${NC}"
        echo ""
        echo -e " ${W}QUICK FIX OPTIONS:${NC}"
        echo ""
        echo -e "  ${C}[1]${NC} Auto-fix all ${D}(restart + clear)${NC}"
        echo -e "  ${C}[2]${NC} Restart proxy only"
        echo -e "  ${C}[3]${NC} Switch model"
        echo -e "  ${C}[4]${NC} Add new account"
        echo -e "  ${C}[0]${NC} Back to menu"
        echo ""
        read -p "  Select fix [0-4]: " fix_choice
        case $fix_choice in
            1) 
                echo ""
                info "Auto-fixing all issues..."
                pkill -9 cli-proxy-api 2>/dev/null
                sleep 2
                # Clear error log
                echo "" > "$PROXY_DIR/cliproxyapi.log" 2>/dev/null
                cd "$PROXY_DIR"
                nohup ./cli-proxy-api > cliproxyapi.log 2>&1 &
                sleep 3
                success "Proxy restarted & logs cleared!"
                ;;
            2) restart_proxy ;;
            3) switch_model ;;
            4) add_account ;;
            *) return ;;
        esac
    fi
    draw_line
    echo ""
}

# Quick health check function - FIXED VERSION
health_check() {
    local issues=0
    
    # Proxy check
    pgrep -f "cli-proxy-api" > /dev/null 2>&1 || ((issues++))
    
    # Account check
    [ $(ls $AUTH_DIR/antigravity-*.json 2>/dev/null | grep -v disabled | wc -l) -eq 0 ] && ((issues++))
    
    # Recent errors check - ONLY LAST 10 LINES
    if [ -f "$PROXY_DIR/cliproxyapi.log" ]; then
        local recent_errors=$(tail -10 "$PROXY_DIR/cliproxyapi.log" 2>/dev/null | grep -E "\[error\].*429|\[error\].*rate.limit|payment_required|Suspended" | wc -l || echo "0")
        [ "$recent_errors" -gt 2 ] && ((issues++))
    fi
    
    echo $issues
}

start_api_server() {
    if ! pgrep -f "degeni-api" > /dev/null 2>&1; then
        mkdir -p "$DEGENI_HOME/logs"
        nohup python3 "$DEGENI_HOME/bin/degeni-api" > "$DEGENI_HOME/logs/api.log" 2>&1 &
        sleep 1
    fi
}

open_dashboard() {
    # Start API server first
    info "Starting API server..."
    start_api_server
    if pgrep -f "degeni-api" > /dev/null 2>&1; then
        success "API server running on port 8321"
    else
        warning "API server failed to start"
    fi
    
    # Start HTTP server for dashboard
    pkill -f "python3 -m http.server 8080" 2>/dev/null
    cd "$DEGENI_HOME/ui" 2>/dev/null || cd "$DEGENI_HOME"
    python3 -m http.server 8080 &>/dev/null &
    sleep 1
    
    echo ""
    success "Dashboard running!"
    echo -e "  ${C}http://localhost:8080/dashboard.html${NC}"
    echo ""
    
    # Try to open in browser
    if command -v xdg-open &> /dev/null; then
        xdg-open "http://localhost:8080/dashboard.html" 2>/dev/null &
    fi
}

chat_mode() {
    # Direct chat mode - no session management
    local current_model=$(get_model)
    export ANTHROPIC_BASE_URL=http://127.0.0.1:8317
    export ANTHROPIC_AUTH_TOKEN=$(grep -A1 "api-keys:" $PROXY_DIR/config.yaml | tail -1 | sed 's/.*"\(sk-[^"]*\)".*/\1/' || echo "sk-dummy-token")
    export ANTHROPIC_DEFAULT_SONNET_MODEL=gemini-claude-sonnet-4-5-thinking
    export ANTHROPIC_DEFAULT_OPUS_MODEL=gemini-claude-opus-4-5-thinking

    info "Starting DEGENI AI Chat... (Model: $current_model)"
    echo ""
    echo -e "  ${D}Type your message and press Enter${NC}"
    echo -e "  ${D}Press Ctrl+C to exit${NC}"
    echo -e "  ${D}Auto-recovery enabled for auth errors${NC}"
    echo ""

    # Use the standalone chat script
    exec $DEGENI_HOME/bin/degeni-chat
}

quick_ask() {
    local current_model=$(get_model)
    export ANTHROPIC_BASE_URL=http://127.0.0.1:8317
    export ANTHROPIC_AUTH_TOKEN=$(grep -A1 "api-keys:" $PROXY_DIR/config.yaml | tail -1 | sed 's/.*"\(sk-[^"]*\)".*/\1/' || echo "sk-default")
    export ANTHROPIC_DEFAULT_SONNET_MODEL=gemini-claude-sonnet-4-5-thinking
    export ANTHROPIC_DEFAULT_OPUS_MODEL=gemini-claude-opus-4-5-thinking
    
    # Try normal request first
    local result=$(claude --model "$current_model" -p "$@" 2>&1)
    
    # Check for auth errors and auto-fix
    if echo "$result" | grep -q "auth_unavailable\|no auth available\|500"; then
        echo -e "\n${Y}‚ö† Auth error detected, attempting auto-recovery...${NC}"
        "$DEGENI_HOME/bin/degeni-smart-handler" auto-fix
        echo -e "${C}üîÑ Retrying request...${NC}\n"
        claude --model "$(get_model)" -p "$@"
    else
        echo "$result"
    fi
}

show_help() {
    draw_line
    echo -e " ${W}DEGENI COMMANDS${NC}"
    draw_line
    echo ""
    echo -e "  ${W}degeni \"...\"${NC}        Quick question to AI"
    echo -e "  ${W}degeni chat${NC}         Interactive chat mode"
    echo -e "  ${W}degeni${NC}              Interactive menu"
    echo ""
    echo -e "  ${W}degeni check${NC}        Quick real-time status"
  echo -e "  ${W}degeni status${NC}       Detailed system status"
    echo -e "  ${W}degeni diagnose${NC}     üîç Diagnose problems + auto-fix"
    echo -e "  ${W}degeni fix${NC}          Same as diagnose"
    echo ""
    echo -e "  ${W}degeni list${NC}         List accounts"
    echo -e "  ${W}degeni add${NC}          Add new account"
    echo -e "  ${W}degeni disable${NC}      Disable account"
    echo -e "  ${W}degeni enable${NC}       Enable account"
    echo -e "  ${W}degeni restart${NC}      Restart proxy"
    echo -e "  ${W}degeni test${NC}         Test accounts"
    echo -e "  ${W}degeni model${NC}        Switch AI model"
    echo ""
    echo -e "  ${W}degeni dash${NC}         Open live dashboard"
    echo -e "  ${W}degeni uninstall${NC}    Uninstall DEGENI"
    echo ""
}

show_menu() {
    echo ""
    echo -e "  ${W}QUICK ACTIONS${NC}"
    echo ""
    echo -e "  ${C}[1]${NC} üí¨ Chat Mode        ${C}[6]${NC} üîÑ Restart Proxy"
    echo -e "  ${C}[2]${NC} üìä Status           ${C}[7]${NC} üß™ Test Accounts"
    echo -e "  ${C}[3]${NC} üìã List Accounts    ${C}[8]${NC} üîÄ Switch Model"
    echo -e "  ${C}[4]${NC} ‚ûï Add Account      ${C}[9]${NC} üåê Dashboard"
    echo -e "  ${C}[5]${NC} ‚öôÔ∏è  Manage Accounts  ${C}[0]${NC} üö™ Exit"
    echo ""
    echo -e "  ${C}[e]${NC} ‚ö†Ô∏è  View Errors     ${C}[h]${NC} ‚ùì Help"
    echo ""
}

# Main
case "$1" in
    chat|c) clear; print_logo; chat_mode ;;
    ask|a) shift; quick_ask "$@" ;;
    status|s) clear; print_logo; quick_status ;;
    check|quick) quick_status ;;
    list|l) clear; print_logo; list_accounts ;;
    add) clear; print_logo; add_account ;;
    disable|d) clear; print_logo; disable_account ;;
    enable|en) clear; print_logo; enable_account ;;
    restart|r) clear; print_logo; restart_proxy ;;
    test|t) clear; print_logo; test_accounts ;;
    model|m) clear; print_logo; switch_model ;;
    errors|err|diagnose|diag|fix) clear; print_logo; diagnose_problems ;;
    dash|ui) clear; print_logo; open_dashboard ;;
    uninstall) bash "$DEGENI_HOME/uninstall.sh" ;;
    help|h|-h|--help) clear; print_logo; show_help ;;
    version|-v|--version) echo "DEGENI v$VERSION by BITZY.ID" ;;
    "")
        # No arguments - show interactive menu
        while true; do
            clear
            print_logo
            quick_status
            show_menu
            read -p "  Select [0-9/e/h]: " choice
            case $choice in
                1) chat_mode ;;
                2) quick_status; read -p "  Press Enter..." ;;
                3) list_accounts; read -p "  Press Enter..." ;;
                4) add_account; read -p "  Press Enter..." ;;
                5) echo -e "\n  ${C}[d]${NC} Disable  ${C}[e]${NC} Enable"; read -p "  Choice: " c
                   [ "$c" == "d" ] && disable_account || enable_account; read -p "  Press Enter..." ;;
                6) restart_proxy; read -p "  Press Enter..." ;;
                7) test_accounts; read -p "  Press Enter..." ;;
                8) switch_model; read -p "  Press Enter..." ;;
                9) open_dashboard; read -p "  Press Enter..." ;;
                0|q) echo ""; info "Goodbye!"; exit 0 ;;
                e|E) view_errors; read -p "  Press Enter..." ;;
                h|H) show_help; read -p "  Press Enter..." ;;
            esac
        done
        ;;
    *)
        # Any other argument = quick ask
        quick_ask "$@"
        ;;
esac
